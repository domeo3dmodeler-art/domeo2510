# АНАЛИЗ СИСТЕМЫ ИМПОРТА ТОВАРОВ

## 1. МЕХАНИЗМ ШАБЛОНОВ

### Структура шаблонов в базе данных:
- **Таблица**: `import_templates`
- **Связь**: Один шаблон на категорию каталога (`catalog_category_id` UNIQUE)
- **Поля**:
  - `required_fields` - JSON массив обязательных полей
  - `calculator_fields` - JSON массив полей для калькулятора  
  - `export_fields` - JSON массив полей для экспорта
  - `template_config` - JSON конфигурация шаблона
  - `field_mappings` - JSON маппинг полей
  - `validation_rules` - JSON правила валидации

### Создание шаблонов:
1. **API**: `/api/admin/import-templates` (POST)
2. **Логика**: Проверяет существование шаблона для категории
3. **Если существует**: Использует существующий (НЕ обновляет)
4. **Если нет**: Создает новый шаблон

### Редактирование шаблонов:
1. **API**: `/api/admin/templates` (PUT)
2. **Проблема**: Нет полноценного интерфейса редактирования
3. **Текущее состояние**: Только функция "в разработке" в админ панели

## 2. МЕХАНИЗМ ЭКСПОРТА

### Экспорт прайс-листа:
- **API**: `/api/admin/export/price-list`
- **Поля в экспорте**:
  ```
  №, SKU, Название, Артикул поставщика, Ширина/мм, Высота/мм, 
  Толщина/мм, Цвет, Стиль, Тип конструкции, Тип открывания, 
  Поставщик, Цена ррц, Цена опт, Цена базовая, Остаток
  ```

### Источники данных:
- **Основные поля**: `sku`, `name`, `base_price`, `stock_quantity`
- **Свойства товара**: Из `properties_data` JSON поля
- **Маппинг полей**: 
  - `Domeo_Цвет` → Цвет
  - `Domeo_Стиль Web` → Стиль
  - `Цена РРЦ` → Цена ррц
  - И т.д.

## 3. ПРОБЛЕМЫ В ТЕКУЩЕЙ СИСТЕМЕ

### 3.1 Проблемы с кодировкой:
- **Симптом**: В логах видны символы `??????` вместо русских букв
- **Причина**: Неправильная обработка UTF-8 в базе данных
- **Влияние**: Названия полей и значений отображаются некорректно

### 3.2 Проблемы с шаблонами:
- **Отсутствие интерфейса**: Нет полноценного UI для редактирования шаблонов
- **Статичность**: Шаблоны создаются один раз и не обновляются
- **Неполные данные**: `calculator_fields` и `export_fields` пустые

### 3.3 Проблемы с импортом:
- **Дублирование логики**: Несколько API для импорта (`universal`, `import-templates/import`)
- **Несогласованность**: Разные подходы к обработке данных
- **Ошибки валидации**: Не все поля проверяются корректно

### 3.4 Проблемы с экспортом:
- **Жестко заданные поля**: Поля экспорта захардкожены в коде
- **Отсутствие гибкости**: Нет возможности настраивать поля экспорта
- **Неполные данные**: Некоторые поля могут быть пустыми

## 4. АНАЛИЗ СУЩЕСТВУЮЩЕГО ШАБЛОНА ДВЕРЕЙ

### Обязательные поля (22 поля):
1. Domeo Артикул 1C (Проставляется атоматически)
2. Артикул поставщика  
3. Domeo_Название модели для Web
4. Ширина/мм
5. Высота/мм
6. Толщина/мм
7. Общее_Тип покрытия
8. Domeo_Цвет
9. Domeo_Стиль Web
10. Наименование поставщика
11. Наименование у поставщика
12. Поставщик
13. Ед.изм.
14. Склад/заказ
15. Цена ррц (включая цену полотна, короба, наличников, доборов)
16. Цена опт
17. Кромка
18. Стоимость надбавки за кромку
19. Молдинг
20. Стекло
21. Фабрика_Коллекция
22. Фабрика_Цвет/Отделка

### Проблемы шаблона:
- **Избыточность**: Слишком много обязательных полей
- **Дублирование**: Несколько полей для одного и того же (например, цвета)
- **Сложность**: Сложные названия полей затрудняют понимание

## 5. РЕКОМЕНДАЦИИ ПО УЛУЧШЕНИЮ

### 5.1 Исправление кодировки:
- Добавить правильную обработку UTF-8 во всех API
- Использовать `fixFieldsEncoding` функцию везде
- Проверить настройки базы данных

### 5.2 Улучшение шаблонов:
- Создать полноценный интерфейс редактирования шаблонов
- Добавить возможность создания шаблонов из существующих товаров
- Реализовать версионирование шаблонов

### 5.3 Унификация импорта:
- Объединить логику импорта в один API
- Стандартизировать обработку ошибок
- Добавить детальную валидацию

### 5.4 Гибкий экспорт:
- Сделать поля экспорта настраиваемыми
- Добавить возможность выбора полей для экспорта
- Создать предустановленные конфигурации экспорта

### 5.5 Упрощение шаблона дверей:
- Сократить количество обязательных полей
- Убрать дублирующиеся поля
- Упростить названия полей
- Добавить группировку полей по категориям
