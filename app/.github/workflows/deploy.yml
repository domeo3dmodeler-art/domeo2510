name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: '18'
  REGISTRY: cr.yandex
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
        
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
      
    - name: Run linting
      working-directory: ./app
      run: npm run lint
      
    - name: Run type checking
      working-directory: ./app
      run: npm run build

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
        
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
      
    - name: Build application
      working-directory: ./app
      run: npm run build
      
    - name: Configure Docker to use gcloud as a credential helper
      run: |
        echo '${{ secrets.YC_SA_KEY }}' | docker login --username json --password-stdin cr.yandex
        
    - name: Build and push Docker image
      working-directory: ./app
      run: |
        docker build -f Dockerfile.yandex -t ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker push ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker tag ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Yandex Cloud CLI
      uses: yandex-cloud/yc-cli-action@v1
      with:
        yc-sa-json-credentials: ${{ secrets.YC_SA_KEY }}
        
    - name: Deploy to Yandex Cloud
      run: |
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Compute Instance
        INSTANCE_ID=$(yc compute instance list --format json | jq -r '.[0].id')
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
        
        # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
        docker stop domeo-doors-app || true
        docker rm domeo-doors-app || true
        
        # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ Ð¾Ð±Ñ€Ð°Ð·Ð°
        docker rmi cr.yandex/$YC_REGISTRY_ID/$IMAGE_NAME:latest || true
        
        # ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð² Container Registry
        echo "$YC_SA_KEY" | docker login --username json --password-stdin cr.yandex
        
        # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¾Ð±Ñ€Ð°Ð·Ð°
        docker pull cr.yandex/$YC_REGISTRY_ID/$IMAGE_NAME:latest
        
        # Ð—Ð°Ð¿ÑƒÑÐº Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
        docker run -d \
          --name domeo-doors-app \
          --restart unless-stopped \
          -p 3000:3000 \
          -e DATABASE_URL="$DATABASE_URL" \
          -e JWT_SECRET="$JWT_SECRET" \
          -e NODE_ENV=production \
          -e PORT=3000 \
          -e NEXT_PUBLIC_APP_URL="$NEXT_PUBLIC_APP_URL" \
          cr.yandex/$YC_REGISTRY_ID/$IMAGE_NAME:latest
        
        echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
        EOF
        
        # ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
        export YC_REGISTRY_ID="${{ secrets.YC_REGISTRY_ID }}"
        export IMAGE_NAME="${{ env.IMAGE_NAME }}"
        export YC_SA_KEY="${{ secrets.YC_SA_KEY }}"
        export DATABASE_URL="${{ secrets.DATABASE_URL }}"
        export JWT_SECRET="${{ secrets.JWT_SECRET }}"
        export NEXT_PUBLIC_APP_URL="${{ secrets.NEXT_PUBLIC_APP_URL }}"
        
        # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
        yc compute instance execute $INSTANCE_ID --command "bash -s" < deploy.sh
        
    - name: Health check
      run: |
        # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        sleep 30
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP ÑÐµÑ€Ð²ÐµÑ€Ð°
        EXTERNAL_IP=$(yc compute instance list --format json | jq -r '.[0].network_interfaces[0].primary_v4_address.one_to_one_nat.address')
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        curl -f http://$EXTERNAL_IP:3000/api/health || exit 1
        
        echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¾ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"
        echo "ðŸŒ URL: http://$EXTERNAL_IP:3000"
