# üß™ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã –Ω–∞ VM

## üéØ –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π VM –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–¥ production.

## üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### 1. –°–æ–∑–¥–∞–π—Ç–µ staging VM –Ω–∞ Yandex Cloud
```bash
# –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é VM —Å —Ç–µ–º–∏ –∂–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ —á—Ç–æ –∏ production
# Ubuntu 20.04, 2 vCPU, 4GB RAM, 20GB SSD
# –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç—ã: 22, 3001, 80, 443
```

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSH –¥–æ—Å—Ç—É–ø
```bash
# –°–æ–∑–¥–∞–π—Ç–µ SSH –∫–ª—é—á –¥–ª—è staging
ssh-keygen -t rsa -b 4096 -f staging_key -N ""

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ staging VM
ssh-copy-id -i staging_key.pub ubuntu@<STAGING_IP>

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
cat staging_key.pub | ssh ubuntu@<STAGING_IP> "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ staging VM
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
./setup-staging-vm.sh
```

### 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å production
```bash
# –ü–æ–ª—É—á–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å production VM
./sync-from-production.ps1

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git diff

# –î–æ–±–∞–≤—å—Ç–µ –∏ –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ
git add .
git commit -m "sync: production changes from VM"

# –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤ feature –≤–µ—Ç–∫—É
git push origin feature/sync-production-changes
```

### 5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ staging
```bash
# –î–µ–ø–ª–æ–π –Ω–∞ staging
./deploy-staging-safe.sh

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É
curl http://<STAGING_IP>:3001/api/health
```

## üîÑ Workflow —Å —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–æ–π

### **–ù–æ–≤—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å:**

1. **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ** ‚Üí `feature/new-feature`
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ staging VM** ‚Üí `develop` ‚Üí staging VM
3. **Production –¥–µ–ø–ª–æ–π** ‚Üí `main` ‚Üí production VM

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–µ—Ç–æ–∫:**
```
main (production VM) ‚Üê‚îÄ‚îÄ develop (staging VM) ‚Üê‚îÄ‚îÄ feature/new-feature (local)
     ‚Üë                        ‚Üë                           ‚Üë
   –¢–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤–æ–µ          –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ                –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
   –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–¥          –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ VM             –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã
```

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ staging VM

### **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
```bash
# –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
ssh -i staging_key ubuntu@<STAGING_IP> 'sudo systemctl status domeo-staging'

# –õ–æ–≥–∏
ssh -i staging_key ubuntu@<STAGING_IP> 'sudo journalctl -u domeo-staging -f'

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
ssh -i staging_key ubuntu@<STAGING_IP> 'sudo systemctl restart domeo-staging'

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
ssh -i staging_key ubuntu@<STAGING_IP> 'sudo systemctl stop domeo-staging'
```

### **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ staging:**
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π
./deploy-staging-safe.sh

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
git checkout develop
git pull origin develop
./deploy-staging-safe.sh
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### **–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env.staging:**
```bash
# Staging Environment
NODE_ENV=staging
NEXT_PUBLIC_BASE_URL=http://<STAGING_IP>:3001

# Database
DATABASE_URL="file:./dev.db"

# JWT
JWT_SECRET="staging-jwt-secret-key"

# File Storage (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π bucket –¥–ª—è staging)
YANDEX_ACCESS_KEY_ID="your-access-key"
YANDEX_SECRET_ACCESS_KEY="your-secret-key"
YANDEX_BUCKET_NAME="domeo-staging"
YANDEX_REGION="ru-central1"
```

## üö® –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ SSH –∫–ª—é—á–∏ –¥–ª—è staging –∏ production
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π Yandex bucket –¥–ª—è staging
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ production –¥–∞–Ω–Ω—ã–µ –≤ staging

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã –¥–ª—è staging
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ª–æ–≥–∏
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### **–ë—ç–∫–∞–ø—ã:**
- Staging VM –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å —Å–≤–æ–∏ –±—ç–∫–∞–ø—ã
- –ù–µ –ø–æ–ª–∞–≥–∞–π—Ç–µ—Å—å –Ω–∞ staging –∫–∞–∫ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –±—ç–∫–∞–ø production

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ä–∏—Å–∫–∞ –¥–ª—è production  
‚úÖ **–ö–∞—á–µ—Å—Ç–≤–æ** - –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –¥–æ production  
‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å** - –±—ã—Å—Ç—Ä—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏  
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ production —Ä–µ–ª–∏–∑—ã  
‚úÖ **–ö–æ–º–∞–Ω–¥–∞** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏  

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–æ–∑–¥–∞–π—Ç–µ staging VM** –Ω–∞ Yandex Cloud
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSH –¥–æ—Å—Ç—É–ø** —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ setup-staging-vm.sh** –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
4. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** —Å production VM
5. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ workflow** –Ω–∞ staging
6. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–ø–ª–æ–∏** —á–µ—Ä–µ–∑ GitHub Actions
