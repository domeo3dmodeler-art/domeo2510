#!/bin/bash
# ============================================
# –°–ö–†–ò–ü–¢ –†–ï–ó–ï–†–í–ù–û–ì–û –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• DOMEO
# ============================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BACKUP_DIR="./backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
DB_FILE="./prisma/database/dev.db"
BACKUP_FILE="${BACKUP_DIR}/domeo_backup_${TIMESTAMP}.db"

echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤
mkdir -p "$BACKUP_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
if [ ! -f "$DB_FILE" ]; then
    echo "‚ùå –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω: $DB_FILE"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é SQLite –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üì¶ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é SQLite –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
cp "$DB_FILE" "$BACKUP_FILE"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_FILE (—Ä–∞–∑–º–µ—Ä: $BACKUP_SIZE)"

# –°–æ–∑–¥–∞–µ–º SQL –¥–∞–º–ø –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
SQL_DUMP_FILE="${BACKUP_DIR}/domeo_sql_dump_${TIMESTAMP}.sql"
echo "üìÑ –°–æ–∑–¥–∞–µ–º SQL –¥–∞–º–ø..."

# –ò—Å–ø–æ–ª—å–∑—É–µ–º sqlite3 –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è SQL –¥–∞–º–ø–∞
sqlite3 "$DB_FILE" ".dump" > "$SQL_DUMP_FILE"

SQL_DUMP_SIZE=$(du -h "$SQL_DUMP_FILE" | cut -f1)
echo "‚úÖ SQL –¥–∞–º–ø —Å–æ–∑–¥–∞–Ω: $SQL_DUMP_FILE (—Ä–∞–∑–º–µ—Ä: $SQL_DUMP_SIZE)"

# –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
ARCHIVE_FILE="${BACKUP_DIR}/domeo_backup_${TIMESTAMP}.tar.gz"
echo "üóúÔ∏è –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏..."

tar -czf "$ARCHIVE_FILE" \
    "$BACKUP_FILE" \
    "$SQL_DUMP_FILE" \
    "./prisma/schema.prisma" \
    "./package.json" \
    "./README.md" \
    --exclude="node_modules" \
    --exclude=".git"

ARCHIVE_SIZE=$(du -h "$ARCHIVE_FILE" | cut -f1)
echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $ARCHIVE_FILE (—Ä–∞–∑–º–µ—Ä: $ARCHIVE_SIZE)"

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±—ç–∫–∞–ø–µ
INFO_FILE="${BACKUP_DIR}/backup_info_${TIMESTAMP}.txt"
cat > "$INFO_FILE" << EOF
# –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è DOMEO Platform
–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: $(date)
–í–µ—Ä—Å–∏—è —Å—Ö–µ–º—ã: $(grep -o 'version.*' package.json || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
–†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: $BACKUP_SIZE
–†–∞–∑–º–µ—Ä SQL –¥–∞–º–ø–∞: $SQL_DUMP_SIZE
–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: $ARCHIVE_SIZE

–§–∞–π–ª—ã:
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $BACKUP_FILE
- SQL –¥–∞–º–ø: $SQL_DUMP_FILE
- –ê—Ä—Ö–∏–≤: $ARCHIVE_FILE

–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:
1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
   cp $BACKUP_FILE ./prisma/database/dev.db

2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ SQL –¥–∞–º–ø–∞:
   sqlite3 ./prisma/database/dev.db < $SQL_DUMP_FILE

3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∞—Ä—Ö–∏–≤–∞:
   tar -xzf $ARCHIVE_FILE
EOF

echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—ç–∫–∞–ø–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: $INFO_FILE"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
echo ""
echo "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ï–ó–ï–†–í–ù–û–ì–û –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø:"
echo "=================================="
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±—ç–∫–∞–ø–æ–≤: $BACKUP_DIR"
echo "üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $BACKUP_SIZE"
echo "üìÑ SQL –¥–∞–º–ø: $SQL_DUMP_SIZE"
echo "üóúÔ∏è –ê—Ä—Ö–∏–≤: $ARCHIVE_SIZE"
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: $INFO_FILE"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –±—ç–∫–∞–ø–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
if sqlite3 "$BACKUP_FILE" "SELECT COUNT(*) FROM sqlite_master;" > /dev/null 2>&1; then
    TABLE_COUNT=$(sqlite3 "$BACKUP_FILE" "SELECT COUNT(*) FROM sqlite_master WHERE type='table';")
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ü–µ–ª–∞, —Ç–∞–±–ª–∏—Ü: $TABLE_COUNT"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º SQL –¥–∞–º–ø
if [ -s "$SQL_DUMP_FILE" ]; then
    echo "‚úÖ SQL –¥–∞–º–ø —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞: SQL –¥–∞–º–ø –ø—É—Å—Ç!"
    exit 1
fi

echo ""
echo "üéâ –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!"
echo "============================================="
echo "–í—Å–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $BACKUP_DIR"
echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤ –Ω–∞ –≤–Ω–µ—à–Ω–∏–π –Ω–æ—Å–∏—Ç–µ–ª—å"
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
echo "üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo "=================="
echo "1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤ –Ω–∞ –≤–Ω–µ—à–Ω–∏–π –Ω–æ—Å–∏—Ç–µ–ª—å"
echo "2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PostgreSQL –Ω–∞ Yandex Cloud"
echo "3. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É"
echo "4. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏"
echo ""

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
RESTORE_SCRIPT="${BACKUP_DIR}/restore_backup.sh"
cat > "$RESTORE_SCRIPT" << 'EOF'
#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏

if [ $# -eq 0 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–ø—É—Ç—å_–∫_–∞—Ä—Ö–∏–≤—É>"
    echo "–ü—Ä–∏–º–µ—Ä: $0 domeo_backup_20241201_143022.tar.gz"
    exit 1
fi

ARCHIVE_FILE="$1"
BACKUP_DIR="./backups"

if [ ! -f "$ARCHIVE_FILE" ]; then
    echo "‚ùå –ê—Ä—Ö–∏–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω: $ARCHIVE_FILE"
    exit 1
fi

echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –∞—Ä—Ö–∏–≤–∞: $ARCHIVE_FILE"

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∞—Ä—Ö–∏–≤
tar -xzf "$ARCHIVE_FILE"

# –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
DB_FILE=$(find . -name "domeo_backup_*.db" | head -1)

if [ -z "$DB_FILE" ]; then
    echo "‚ùå –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞—Ä—Ö–∏–≤–µ"
    exit 1
fi

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo "üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–∑: $DB_FILE"
cp "$DB_FILE" "./prisma/database/dev.db"

echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π"
EOF

chmod +x "$RESTORE_SCRIPT"
echo "üîß –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: $RESTORE_SCRIPT"

echo "‚ú® –ì–æ—Ç–æ–≤–æ! –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞."
