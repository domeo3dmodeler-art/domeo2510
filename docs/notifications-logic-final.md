# üìß –§–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. ‚úÖ Quote (–ö–ü) - **–ù–ï –ë–õ–û–ö–ò–†–£–Æ–¢–°–Ø** –¥–ª—è –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä–∞
2. ‚úÖ Invoice (–°—á–µ—Ç) - –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è **–ü–û–°–õ–ï PAID**
3. ‚úÖ Invoice ORDERED/RECEIVED/COMPLETED - –º–µ–Ω—è–µ—Ç **–¢–û–õ–¨–ö–û** –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
4. ‚úÖ –°—Ç–∞—Ç—É—Å—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ **–í–°–ï–ú** —Å–≤—è–∑–∞–Ω–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
5. ‚úÖ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–æ–≤

---

## üîí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä–∞

### Quote (–ö–ü)
```
‚úÖ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –í–°–ï —Å—Ç–∞—Ç—É—Å—ã –ö–ü
‚úÖ ACCEPTED - –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –º–µ–Ω—è–µ—Ç –í–†–£–ß–ù–£–Æ
‚úÖ –î–∞–ª—å—à–µ ACCEPTED - –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ú–û–ñ–ï–¢ –º–µ–Ω—è—Ç—å
```

### Invoice (–°—á–µ—Ç)
```
‚úÖ –î–û PAID - –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ú–û–ñ–ï–¢ –º–µ–Ω—è—Ç—å
‚ùå –ü–û–°–õ–ï PAID - –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù –¥–ª—è –≠–¢–û–ì–û —Å—á–µ—Ç–∞
‚úÖ –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –î–†–£–ì–ò–ú–ò —Å—á–µ—Ç–∞–º–∏ (–¥–æ PAID)
```

**–ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä–∞:**
- `PAID`
- `ORDERED`
- `RECEIVED_FROM_SUPPLIER`
- `COMPLETED`

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Invoice

### 1. –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –∏ –º–µ–Ω—è–µ—Ç –¥–æ PAID
```
–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä: DRAFT ‚Üí SENT ‚Üí **PAID**
‚úÖ –ú–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã
‚úÖ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
```

### 2. –ü–æ—Å–ª–µ PAID - —Ç–æ–ª—å–∫–æ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
```
–°—Ç–∞—Ç—É—Å PAID
‚ùå –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù –¥–ª—è –≠–¢–û–ì–û —Å—á–µ—Ç–∞
‚úÖ EXECUTOR –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –¥–∞–ª—å—à–µ
```

### 3. EXECUTOR –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã
```
EXECUTOR: PAID ‚Üí ORDERED ‚Üí RECEIVED ‚Üí COMPLETED

ORDERED:
  ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º COMPLECTATOR
  ‚Üí –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: Invoice + Quote

RECEIVED_FROM_SUPPLIER:
  ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º COMPLECTATOR
  ‚Üí –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: Invoice + Quote

COMPLETED:
  ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º COMPLECTATOR
  ‚Üí –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: Invoice + Quote
```

---

## üìä –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤

### Quote (–ö–ü)

| –°—Ç–∞—Ç—É—Å | –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä | –ê–¥–º–∏–Ω |
|--------|--------------|-------|
| DRAFT | ‚úÖ | ‚úÖ |
| SENT | ‚úÖ | ‚úÖ |
| ACCEPTED | ‚úÖ | ‚úÖ |
| REJECTED | ‚úÖ | ‚úÖ |

### Invoice (–°—á–µ—Ç)

| –°—Ç–∞—Ç—É—Å | –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä | –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å | –ê–¥–º–∏–Ω |
|--------|--------------|-------------|-------|
| DRAFT | ‚úÖ | ‚ùå | ‚úÖ |
| SENT | ‚úÖ | ‚ùå | ‚úÖ |
| **PAID** | ‚úÖ *(—Ç–æ–ª—å–∫–æ –°–¢–ê–í–ò–¢–¨)* | ‚úÖ *(—Ç–æ–ª—å–∫–æ –°–¢–ê–í–ò–¢–¨)* | ‚úÖ |
| **ORDERED** | ‚ùå | ‚úÖ | ‚úÖ |
| **RECEIVED** | ‚ùå | ‚úÖ | ‚úÖ |
| **COMPLETED** | ‚ùå | ‚úÖ | ‚úÖ |

**–ñ–∏—Ä–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã** - –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–ª—è –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä–∞

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–¥–µ

### lib/auth/permissions.ts

```typescript
export function canUserChangeStatus(
  userRole: UserRole,
  documentType: string,
  documentStatus?: string
): boolean {
  switch (documentType) {
    case 'quote':
      // –ö–ü –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–ª—è –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä–∞
      return userRole === UserRole.ADMIN || userRole === UserRole.COMPLECTATOR;
    
    case 'invoice':
      // –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ü–û–°–õ–ï PAID
      if (userRole === UserRole.COMPLECTATOR) {
        const blockedStatuses = ['PAID', 'ORDERED', 'RECEIVED_FROM_SUPPLIER', 'COMPLETED'];
        if (documentStatus && blockedStatuses.includes(documentStatus)) {
          return false;
        }
      }
      // EXECUTOR –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å Invoice —Ç–æ–ª—å–∫–æ –≤ —Å—Ç–∞—Ç—É—Å–∞—Ö ORDERED, RECEIVED, COMPLETED
      if (userRole === UserRole.EXECUTOR) {
        const allowedStatuses = ['PAID', 'ORDERED', 'RECEIVED_FROM_SUPPLIER', 'COMPLETED'];
        if (documentStatus && !allowedStatuses.includes(documentStatus)) {
          return false;
        }
      }
      return userRole === UserRole.ADMIN || userRole === UserRole.COMPLECTATOR || userRole === UserRole.EXECUTOR;
  }
}
```

---

## üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. **Invoice PAID**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä
   - –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: –í—Å–µ `EXECUTOR`
   - –°–æ–æ–±—â–µ–Ω–∏–µ: "–°—á–µ—Ç [–Ω–æ–º–µ—Ä] –æ–ø–ª–∞—á–µ–Ω. –ú–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"

2. **Invoice ORDERED**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (SupplierOrder)
   - –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: –í—Å–µ `COMPLECTATOR`
   - –°–æ–æ–±—â–µ–Ω–∏–µ: "–°—á–µ—Ç [–Ω–æ–º–µ—Ä] –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å '–ó–∞–∫–∞–∑ —Ä–∞–∑–º–µ—â–µ–Ω'"

3. **Invoice RECEIVED_FROM_SUPPLIER**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (SupplierOrder)
   - –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: –í—Å–µ `COMPLECTATOR`
   - –°–æ–æ–±—â–µ–Ω–∏–µ: "–°—á–µ—Ç [–Ω–æ–º–µ—Ä] –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å '–ü–æ–ª—É—á–µ–Ω –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞'"

4. **Invoice COMPLETED**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (SupplierOrder)
   - –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: –í—Å–µ `COMPLECTATOR`
   - –°–æ–æ–±—â–µ–Ω–∏–µ: "–°—á–µ—Ç [–Ω–æ–º–µ—Ä] –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å '–ò—Å–ø–æ–ª–Ω–µ–Ω'"

5. **Quote ACCEPTED**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä
   - –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: –í—Å–µ `COMPLECTATOR`
   - –°–æ–æ–±—â–µ–Ω–∏–µ: "–ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è–ª –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ [–Ω–æ–º–µ—Ä]"

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞

### –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –º–æ–∂–µ—Ç:
1. ‚úÖ –ú–µ–Ω—è—Ç—å –í–°–ï —Å—Ç–∞—Ç—É—Å—ã Quote (–≤ —Ç.—á. ACCEPTED)
2. ‚úÖ –ú–µ–Ω—è—Ç—å Invoice –¥–æ PAID
3. ‚úÖ –ú–µ–Ω—è—Ç—å –¥—Ä—É–≥–∏–µ Invoice –¥–æ PAID
4. ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ Quote –∏ Invoice
5. ‚ùå –ù–ï –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å Invoice –ø–æ—Å–ª–µ PAID

### –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç:
1. ‚úÖ –ü–µ—Ä–µ–≤–æ–¥–∏—Ç—å Invoice –∏–∑ PAID –≤ ORDERED
2. ‚úÖ –ü–µ—Ä–µ–≤–æ–¥–∏—Ç—å Invoice –∏–∑ ORDERED –≤ RECEIVED_FROM_SUPPLIER
3. ‚úÖ –ü–µ—Ä–µ–≤–æ–¥–∏—Ç—å Invoice –∏–∑ RECEIVED –≤ COMPLETED
4. ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å SupplierOrder
5. ‚úÖ –ú–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã SupplierOrder

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
```
SupplierOrder: ORDERED ‚Üí Invoice: ORDERED (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
SupplierOrder: RECEIVED ‚Üí Invoice: RECEIVED_FROM_SUPPLIER (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
SupplierOrder: COMPLETED ‚Üí Invoice: COMPLETED (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
```

–í–°–ï —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º.

