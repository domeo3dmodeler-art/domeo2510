# üîç –ö—Ä–∞—Ç–∫–∏–π –∞—É–¥–∏—Ç –ª–æ–≥–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã Domeo

**–î–∞—Ç–∞**: 2025-01-11  
**–°—Ç–∞—Ç—É—Å**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã

---

## üö® –¢–æ–ø-5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

### 1. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ Order –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –∫–æ–¥–µ
- **–ü—Ä–æ–±–ª–µ–º–∞**: –¢—Ä–∏ —Ä–∞–∑–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ Order –≤ —Ä–∞–∑–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
- **–§–∞–π–ª—ã**: `SYSTEM_RULES_AND_PERMISSIONS.md`, `ORDER_STATUS_CHAIN.md`, `DOCUMENT_LOGIC_COMPLETE.md`
- **–†–µ—à–µ–Ω–∏–µ**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤–æ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –∏ –∫–æ–¥–µ

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ DRAFT ‚Üí NEW_PLANNED
- **–ü—Ä–æ–±–ª–µ–º–∞**: Order —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `DRAFT`, –Ω–æ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ Invoice –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å `NEW_PLANNED`
- **–§–∞–π–ª**: `lib/validation/status-transitions.ts`
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ `DRAFT` ‚Üí `NEW_PLANNED` –≤ `STATUS_TRANSITIONS`

### 3. –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –ø—Ä–∞–≤ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä–∞
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ `PAID` ‚Üí `UNDER_REVIEW`, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å `UNDER_REVIEW` –æ–±—Ä–∞—Ç–Ω–æ
- **–§–∞–π–ª—ã**: `lib/auth/permissions.ts`, `app/api/orders/[id]/status/route.ts`
- **–†–µ—à–µ–Ω–∏–µ**: –†–∞–∑—Ä–µ—à–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä—É –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `UNDER_REVIEW` ‚Üí `PAID` –∏–ª–∏ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É `UNDER_REVIEW`

### 4. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –¥–µ–¥—É–±–ª–∏–∫–∞—Ü–∏–∏
- **–ü—Ä–æ–±–ª–µ–º–∞**: –õ–æ–≥–∏–∫–∞ –¥–µ–¥—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ 3+ —Ñ–∞–π–ª–∞—Ö —Å —Ä–∞–∑–ª–∏—á–∏—è–º–∏
- **–§–∞–π–ª—ã**: `app/api/orders/route.ts`, `app/api/documents/create/route.ts`, `app/api/documents/create-batch/route.ts`
- **–†–µ—à–µ–Ω–∏–µ**: –í—ã–Ω–µ—Å—Ç–∏ –≤ `lib/documents/deduplication.ts`

### 5. –†–∏—Å–∫ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π Order ‚Üî Invoice
- **–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º —Ü–∏–∫–ª–∞–º
- **–§–∞–π–ª—ã**: `app/api/orders/[id]/status/route.ts`, `app/api/invoices/[id]/status/route.ts`
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ `skipSync` –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Ü–∏–∫–ª—ã

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö**: 5
- **–í–∞–∂–Ω—ã—Ö**: 4
- **–£–ª—É—á—à–µ–Ω–∏–π**: 3
- **–í—Å–µ–≥–æ**: 12 –ø—Ä–æ–±–ª–µ–º

---

## ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. –î–æ–±–∞–≤–∏—Ç—å –≤ `lib/validation/status-transitions.ts`:
```typescript
order: {
  'DRAFT': ['SENT', 'NEW_PLANNED', 'CANCELLED'],  // –î–æ–±–∞–≤–∏—Ç—å NEW_PLANNED
  // ...
}
```

2. –í—ã–Ω–µ—Å—Ç–∏ –¥–µ–¥—É–±–ª–∏–∫–∞—Ü–∏—é –≤ `lib/documents/deduplication.ts`

3. –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç —Ü–∏–∫–ª–æ–≤ –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:
```typescript
if (order._syncing) return;  // –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–æ–≤
order._syncing = true;
// ... —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
order._syncing = false;
```

---

**–ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç**: –°–º. `docs/AUDIT_LOGIC_COMPLETE.md`

