# Диаграмма системы работы с заказчиками и документами

## 🔄 Жизненный цикл документов

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   КП (Quote)    │    │  Счет (Invoice) │    │  Заказ (Order)  │    │ Заказ поставщика│
│                 │    │                 │    │                 │    │(SupplierOrder) │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │                       │
         ▼                       ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ DRAFT           │    │ DRAFT           │    │ DRAFT           │    │ PENDING         │
│ SENT            │    │ SENT            │    │ CONFIRMED       │    │ ORDERED         │
│ ACCEPTED        │    │ PAID            │    │ IN_PRODUCTION   │    │ IN_PRODUCTION   │
│ REJECTED        │    │ IN_PRODUCTION   │    │ READY           │    │ READY           │
│ CANCELLED       │    │ RECEIVED_FROM_  │    │ COMPLETED       │    │ COMPLETED       │
│                 │    │ SUPPLIER        │    │ CANCELLED       │    │ CANCELLED       │
│                 │    │ COMPLETED       │    │                 │    │                 │
│                 │    │ CANCELLED       │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 👥 Роли и права доступа

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                РОЛИ ПОЛЬЗОВАТЕЛЕЙ                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ADMIN                    COMPLECTATOR                    EXECUTOR             │
│  ─────                    ────────────                    ────────             │
│  ✅ Все права             ✅ Создание КП/Счетов/Заказов    ✅ Заказы поставщиков│
│  ✅ Управление            ✅ Редактирование своих          ✅ Изменение статусов│
│  ✅ Удаление              ✅ Изменение статусов            ❌ Только просмотр   │
│  ✅ Пользователи          ❌ Не может удалять              ❌ Не может создавать│
│  ✅ Настройки             ❌ Не может управлять            ❌ Не может удалять  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🔗 Связи между документами

```
┌─────────────┐    parent_document_id    ┌─────────────┐    parent_document_id    ┌─────────────┐
│     КП      │ ──────────────────────► │    Счет     │ ──────────────────────► │   Заказ     │
│  (Quote)    │                         │  (Invoice)  │                         │  (Order)    │
└─────────────┘                         └─────────────┘                         └─────────────┘
                                                      │
                                                      │ parent_document_id
                                                      ▼
                                               ┌─────────────┐
                                               │ Заказ       │
                                               │ поставщика  │
                                               │(SupplierOrder)│
                                               └─────────────┘
```

## 🔔 Система уведомлений

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              УВЕДОМЛЕНИЯ ПО СТАТУСАМ                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│  КП: SENT → Клиент, ACCEPTED/REJECTED → COMPLECTATOR                           │
│  Счет: SENT → Клиент, PAID → COMPLECTATOR, IN_PRODUCTION → EXECUTOR            │
│  Заказ: CONFIRMED → EXECUTOR, IN_PRODUCTION → COMPLECTATOR                     │
│  Заказ поставщика: ORDERED → COMPLECTATOR, READY → COMPLECTATOR               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🛡️ Правила безопасности

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ПРАВИЛА БЕЗОПАСНОСТИ                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│  1. JWT токен проверяется в middleware                                          │
│  2. Права доступа проверяются на каждом API endpoint                            │
│  3. Все действия логируются в DocumentHistory                                   │
│  4. Статусы валидируются по разрешенным переходам                               │
│  5. Удаление возможно только для ADMIN и только в определенных статусах        │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 📊 Матрица прав доступа

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           МАТРИЦА ПРАВ ДОСТУПА                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│ Действие              │ ADMIN │ COMPLECTATOR │ EXECUTOR │ Клиент │             │
├─────────────────────────────────────────────────────────────────────────────────┤
│ Создание клиента      │  ✅   │     ✅       │    ❌    │   ❌   │             │
│ Редактирование клиента│  ✅   │     ✅       │    ❌    │   ❌   │             │
│ Удаление клиента      │  ✅   │     ❌       │    ❌    │   ❌   │             │
│ Создание КП           │  ✅   │     ✅       │    ❌    │   ❌   │             │
│ Создание Счета        │  ✅   │     ✅       │    ❌    │   ❌   │             │
│ Создание Заказа       │  ✅   │     ✅       │    ❌    │   ❌   │             │
│ Создание Заказа пост. │  ✅   │     ❌       │    ✅    │   ❌   │             │
│ Изменение статуса КП  │  ✅   │     ✅       │    ❌    │   ✅   │             │
│ Изменение статуса Сч. │  ✅   │     ✅       │    ✅    │   ✅   │             │
│ Изменение статуса З.  │  ✅   │     ❌       │    ✅    │   ❌   │             │
│ Изменение статуса ЗП  │  ✅   │     ❌       │    ✅    │   ❌   │             │
│ Удаление документов   │  ✅   │     ❌       │    ❌    │   ❌   │             │
│ Просмотр всех данных  │  ✅   │     ✅       │    ✅    │   ❌   │             │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🎯 Workflow процессов

### Процесс создания КП → Счета → Заказа
```
1. COMPLECTATOR создает КП (DRAFT)
2. COMPLECTATOR отправляет КП клиенту (SENT)
3. Клиент принимает КП (ACCEPTED) → уведомление COMPLECTATOR
4. COMPLECTATOR создает Счет на основе КП (DRAFT)
5. COMPLECTATOR отправляет Счет клиенту (SENT)
6. Клиент оплачивает Счет (PAID) → уведомление COMPLECTATOR
7. COMPLECTATOR переводит в производство (IN_PRODUCTION) → уведомление EXECUTOR
8. EXECUTOR создает Заказ поставщика на основе Заказа
9. EXECUTOR отслеживает выполнение заказа поставщика
10. При завершении всех этапов - уведомления всем участникам
```

### Процесс управления заказчиками
```
1. COMPLECTATOR создает заказчика при первом обращении
2. ADMIN может редактировать данные заказчика
3. При изменении контактов - уведомление связанным пользователям
4. Удаление возможно только ADMIN и только при отсутствии активных документов
5. Все действия с заказчиками логируются
```
