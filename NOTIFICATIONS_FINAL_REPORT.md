# üìß –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç: –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

**–î–∞—Ç–∞:** 29 —è–Ω–≤–∞—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é  
**–í–µ—Ä—Å–∏—è:** Staging (130.193.40.35:3001)

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `lib/auth/permissions.ts`

**–î–æ:**
```typescript
export function canUserChangeStatus(userRole: UserRole, documentType: string) {
  switch (documentType) {
    case 'invoice':
      return userRole === UserRole.ADMIN || userRole === UserRole.COMPLECTATOR;
  }
}
```

**–ü–æ—Å–ª–µ:**
```typescript
export function canUserChangeStatus(
  userRole: UserRole,
  documentType: string,
  documentStatus?: string  // ‚úÖ –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
): boolean {
  switch (documentType) {
    case 'quote':
      // –ö–ü –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–ª—è –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä–∞
      return userRole === UserRole.ADMIN || userRole === UserRole.COMPLECTATOR;
    
    case 'invoice':
      // –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å Invoice —Ç–æ–ª—å–∫–æ –î–û PAID
      if (userRole === UserRole.COMPLECTATOR) {
        const blockedStatuses = ['PAID', 'ORDERED', 'RECEIVED_FROM_SUPPLIER', 'COMPLETED'];
        if (documentStatus && blockedStatuses.includes(documentStatus)) {
          return false;
        }
      }
      // EXECUTOR –ù–ï –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å Invoice –Ω–∞–ø—Ä—è–º—É—é
      // –û–Ω –º–µ–Ω—è–µ—Ç SupplierOrder, –∞ Invoice —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      return userRole === UserRole.ADMIN || userRole === UserRole.COMPLECTATOR;
  }
}
```

### 2. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `app/api/documents/[id]/status/route.ts`

**–î–æ:**
```typescript
if (!canUserChangeStatus(userRole, documentType)) {
```

**–ü–æ—Å–ª–µ:**
```typescript
if (!canUserChangeStatus(userRole, documentType, document.status)) {
```

---

## üìä –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤

### Quote (–ö–ü)

| –°—Ç–∞—Ç—É—Å | –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä | –ê–¥–º–∏–Ω | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ |
|--------|--------------|-------|------------|
| DRAFT | ‚úÖ | ‚úÖ | ‚ùå |
| SENT | ‚úÖ | ‚úÖ | ‚ùå |
| ACCEPTED | ‚úÖ | ‚úÖ | ‚ùå |
| REJECTED | ‚úÖ | ‚úÖ | ‚ùå |

**–í—ã–≤–æ–¥:** –ö–ü –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–ª—è –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä–∞.

### Invoice (–°—á–µ—Ç)

| –°—Ç–∞—Ç—É—Å | –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä | –ê–¥–º–∏–Ω | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ |
|--------|--------------|-------|------------|
| DRAFT | ‚úÖ | ‚úÖ | ‚ùå |
| SENT | ‚úÖ | ‚úÖ | ‚ùå |
| PAID | ‚úÖ *(—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç)* | ‚úÖ | ‚úÖ **–ë–õ–û–ö–ò–†–û–í–ê–ù** |
| ORDERED | ‚ùå | ‚úÖ | ‚úÖ **–ë–õ–û–ö–ò–†–û–í–ê–ù** |
| RECEIVED | ‚ùå | ‚úÖ | ‚úÖ **–ë–õ–û–ö–ò–†–û–í–ê–ù** |
| COMPLETED | ‚ùå | ‚úÖ | ‚úÖ **–ë–õ–û–ö–ò–†–û–í–ê–ù** |

**–í—ã–≤–æ–¥:** –ü–æ—Å–ª–µ PAID –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≠–¢–û–ì–û —Å—á–µ—Ç–∞.

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Quote

1. **–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç Quote**
   - –°—Ç–∞—Ç—É—Å: DRAFT
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –ù–µ—Ç

2. **–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Quote**
   - –°—Ç–∞—Ç—É—Å: SENT
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –ù–µ—Ç (–∫–ª–∏–µ–Ω—Ç –Ω–µ –∑–∞—Ö–æ–¥–∏—Ç –≤ —Å–∏—Å—Ç–µ–º—É)

3. **–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ø–µ—Ä–µ–≤–æ–¥–∏—Ç Quote –≤ ACCEPTED**
   - –°—Ç–∞—Ç—É—Å: ACCEPTED
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: üìß –í—Å–µ–º COMPLECTATOR
   - "–ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è–ª –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ [–Ω–æ–º–µ—Ä]"
   - ‚úÖ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è (–º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –¥–∞–ª—å—à–µ)

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Invoice

1. **–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç Invoice –∏–∑ Quote**
   - –°—Ç–∞—Ç—É—Å: DRAFT
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –ù–µ—Ç

2. **–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Invoice**
   - –°—Ç–∞—Ç—É—Å: SENT
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –ù–µ—Ç

3. **–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ø–µ—Ä–µ–≤–æ–¥–∏—Ç Invoice –≤ PAID**
   - –°—Ç–∞—Ç—É—Å: PAID
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: üìß –í—Å–µ–º EXECUTOR
   - "–°—á–µ—Ç [–Ω–æ–º–µ—Ä] –æ–ø–ª–∞—á–µ–Ω. –ú–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"
   - ‚úÖ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù –¥–ª—è –≠–¢–û–ì–û —Å—á–µ—Ç–∞

4. **–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç SupplierOrder**
   - –°–≤—è–∑–∞–Ω —Å Invoice —á–µ—Ä–µ–∑ `parent_document_id`

5. **–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç SupplierOrder –≤ ORDERED**
   - –°—Ç–∞—Ç—É—Å: ORDERED
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: üìß –í—Å–µ–º COMPLECTATOR
   - "–ó–∞–∫–∞–∑ —Ä–∞–∑–º–µ—â–µ–Ω —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"
   - –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: Invoice ‚Üí ORDERED

6. **–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç SupplierOrder –≤ RECEIVED_FROM_SUPPLIER**
   - –°—Ç–∞—Ç—É—Å: RECEIVED_FROM_SUPPLIER
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: üìß –í—Å–µ–º COMPLECTATOR
   - "–¢–æ–≤–∞—Ä –ø–æ–ª—É—á–µ–Ω –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"
   - –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: Invoice ‚Üí RECEIVED_FROM_SUPPLIER

7. **–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç SupplierOrder –≤ COMPLETED**
   - –°—Ç–∞—Ç—É—Å: COMPLETED
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: üìß –í—Å–µ–º COMPLECTATOR
   - "–ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–º"
   - –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: Invoice ‚Üí COMPLETED

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ API

```typescript
// app/api/documents/[id]/status/route.ts
if (!canUserChangeStatus(userRole, documentType, document.status)) {
  return NextResponse.json(
    { error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞' },
    { status: 403 }
  );
}
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

```typescript
// app/api/supplier-orders/[id]/status/route.ts
async function synchronizeDocumentStatuses(invoiceId: string, supplierOrderStatus: string) {
  const statusMapping = {
    'ORDERED': { invoice: 'ORDERED' },
    'RECEIVED_FROM_SUPPLIER': { invoice: 'RECEIVED_FROM_SUPPLIER' },
    'COMPLETED': { invoice: 'COMPLETED' }
  };
  
  await prisma.invoice.update({
    where: { id: invoiceId },
    data: { status: mappedStatuses.invoice }
  });
}
```

---

## üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. **Invoice PAID** ‚Üí –≤—Å–µ–º `EXECUTOR`
2. **Invoice ORDERED** ‚Üí –≤—Å–µ–º `COMPLECTATOR` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
3. **Invoice RECEIVED** ‚Üí –≤—Å–µ–º `COMPLECTATOR` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
4. **Invoice COMPLETED** ‚Üí –≤—Å–µ–º `COMPLECTATOR` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
5. **Quote ACCEPTED** ‚Üí –≤—Å–µ–º `COMPLECTATOR`

### –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π

```typescript
// lib/notifications.ts
const existingNotification = await prisma.notification.findFirst({
  where: {
    user_id: data.userId,
    document_id: data.documentId,
    type: data.type,
    is_read: false,
    created_at: { gte: new Date(Date.now() - 5 * 60 * 1000) }
  }
});
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –º–æ–∂–µ—Ç:
1. ‚úÖ –ú–µ–Ω—è—Ç—å –í–°–ï —Å—Ç–∞—Ç—É—Å—ã Quote
2. ‚úÖ –ú–µ–Ω—è—Ç—å Invoice –¥–æ PAID
3. ‚úÖ –ú–µ–Ω—è—Ç—å –¥—Ä—É–≥–∏–µ Invoice –¥–æ PAID
4. ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ Quote –∏ Invoice
5. ‚ùå –ù–ï –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å Invoice –ø–æ—Å–ª–µ PAID

### –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç:
1. ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å SupplierOrder
2. ‚úÖ –ú–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã SupplierOrder
3. ‚ùå –ù–ï –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å Invoice –Ω–∞–ø—Ä—è–º—É—é
4. ‚úÖ Invoice —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üß™ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

1. ‚úÖ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å Quote –ø–æ—Å–ª–µ ACCEPTED?
2. ‚úÖ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ç–æ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏–∑–º–µ–Ω–∏—Ç—å Invoice –ø–æ—Å–ª–µ PAID?
3. ‚úÖ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å SupplierOrder?
4. ‚úÖ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Invoice –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ SupplierOrder?
5. ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ?
6. ‚úÖ –ù–µ—Ç –¥—É–±–ª–µ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π?

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –Ω–∞ staging
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–µ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –æ—Ç–≤–µ—Ç—ã (403 –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤

