# Контекст для работы с загрузкой фото

## Текущая проблема

После исправления ошибки `nameWithoutExt is not defined` загрузка фото должна работать корректно.

## Текущая логика обработки фото

### 1. При импорте (`app/api/admin/import/photos/route.ts`)

Логика определения обложки/галереи (строки 203-225):
- Ищется паттерн `/_(\d+)$/` в имени файла без расширения
- Если найден (например, `d29_1` находит `_1`):
  - `baseName` = имя без суффикса (например, `d29`)
  - `galleryNumber` = номер из паттерна (например, `1`)
  - `isCover = false`
- Если НЕ найден (например, `d29`):
  - `baseName` = полное имя файла (например, `d29`)
  - `galleryNumber = null`
  - `isCover = true`

Примеры:
- `d29.png` → `propertyValue = "d29"`, `photoType = "cover"`
- `d29_1.png` → `propertyValue = "d29_1"`, `photoType = "gallery_1"`

### 2. При чтении (`app/api/catalog/doors/photos-batch/route.ts`)

Поиск фото для модели (строки 103-117):
1. Сначала ищется по `propertyName = "Domeo_Название модели для Web"`
2. Если не найдено, ищется по `propertyName = "Артикул поставщика"` (fallback)

Структурирование фото (`lib/property-photos.ts`, функции `structurePropertyPhotos`):
1. Ищется фото с `photoType = "cover"` → это обложка
2. Остальные фото (не обложка) → галерея
3. Если нет явной обложки, первое фото (с самым коротким именем) → обложка

### 3. Важные файлы

- **`app/api/admin/import/photos/route.ts`**: Импорт фото через UI (строка 264: определение `nameWithoutExt`)
- **`app/api/catalog/doors/photos-batch/route.ts`**: Загрузка фото для каталога
- **`lib/property-photos.ts`**: Утилиты для работы с фото в БД
- **`app/doors/page.tsx`**: Отображение фото на фронтенде

## Текущий статус

✅ Логика определения обложки/галереи исправлена
✅ Добавлен fallback поиск по артикулу
✅ Исправлена ошибка `nameWithoutExt is not defined`
✅ Старые фото удалены из БД (выполнено: `delete-photos-by-article.js`)
✅ Код закоммичен и отправлен на сервер
✅ Сборка запущена

## Что нужно проверить

1. После завершения сборки попросить пользователя загрузить фото через `/admin/import/photos`
2. Выбрать:
   - Категория: `cmg50xcgs001cv7mn0tdyk1wo` (Межкомнатные двери)
   - Свойство для привязки: `Артикул поставщика`
   - Загрузить файлы: `d29.png`, `d29_1.png`
3. Проверить сохранение в БД:
   - `d29.png` → `propertyValue = "d29"`, `photoType = "cover"`
   - `d29_1.png` → `propertyValue = "d29_1"`, `photoType = "gallery_1"`
4. Проверить отображение на странице `/doors`

## Логи для проверки

```bash
# Проверить логи контейнера
docker logs domeo-staging-app --tail 100

# Проверить фото в БД
docker exec domeo-staging-postgres psql -U postgres -d domeo -c "SELECT propertyValue, photoType FROM property_photo WHERE propertyName = 'Артикул поставщика' ORDER BY propertyValue LIMIT 20;"

# Проверить сборку
docker ps | grep staging-app
```

## Возможные проблемы

1. **Фото не отображаются на странице**:
   - Проверить, что фото загружены с правильными типами
   - Проверить логи API `photos-batch`
   - Проверить, что файлы физически существуют в `public/uploads/`

2. **Неправильное определение обложки/галереи**:
   - Проверить логи импорта в консоли
   - Проверить, что паттерн `/_(\d+)$/` правильно работает для конкретных имен файлов

3. **Ошибка 500 при загрузке**:
   - Проверить логи контейнера
   - Проверить, что все переменные определены

## Следующие шаги

1. Дождаться завершения сборки
2. Попросить пользователя загрузить фото
3. Проверить результат в БД и на странице
4. При необходимости добавить логирование для отладки
