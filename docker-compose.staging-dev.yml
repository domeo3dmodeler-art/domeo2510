version: '3.8'

services:
  # Staging Database
  staging-postgres:
    image: postgres:15-alpine
    container_name: domeo-staging-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: domeo_staging
      POSTGRES_USER: staging_user
      POSTGRES_PASSWORD: staging_password
    volumes:
      - staging_postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - staging-network

  # Staging Redis
  staging-redis:
    image: redis:7-alpine
    container_name: domeo-staging-redis
    restart: unless-stopped
    command: redis-server --requirepass staging_redis_password
    volumes:
      - staging_redis_data:/data
    ports:
      - "6380:6379"
    networks:
      - staging-network

  # Staging App (Hot Reload Mode)
  staging-app:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ Node.js –≤–º–µ—Å—Ç–æ —Å–±–æ—Ä–∫–∏
    image: node:20-alpine
    container_name: domeo-staging-app
    restart: unless-stopped
    working_dir: /app
    # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –¥–ª—è hot reload
    volumes:
      # –í–µ—Å—å –ø—Ä–æ–µ–∫—Ç (–±–µ–∑ :ro —á—Ç–æ–±—ã Next.js –º–æ–≥ —Å–æ–∑–¥–∞–≤–∞—Ç—å .next)
      - .:/app
      # node_modules (volume –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏)
      - staging_node_modules:/app/node_modules
      # Uploads –∏ –ª–æ–≥–∏ (read-write)
      - staging_uploads:/app/public/uploads
      - staging_logs:/app/logs
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://staging_user:staging_password@staging-postgres:5432/domeo_staging
      REDIS_URL: redis://:staging_redis_password@staging-redis:6379
      NEXTAUTH_SECRET: staging_secret_key_minimum_32_characters
      NEXTAUTH_URL: http://130.193.40.35:3001
      JWT_SECRET: staging_jwt_secret_key_minimum_32_characters
      PORT: 3001
      HOSTNAME: 0.0.0.0
      NEXT_TELEMETRY_DISABLED: 1
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
    ports:
      - "3001:3001"
    networks:
      - staging-network
    depends_on:
      - staging-postgres
      - staging-redis
    # –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ –≤ dev —Ä–µ–∂–∏–º–µ –¥–ª—è hot reload
    command: >
      sh -c "
        if ! command -v chromium-browser >/dev/null 2>&1; then
          echo 'üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Chromium...' &&
          apk add --no-cache chromium chromium-chromedriver
        fi &&
        if [ ! -d node_modules ]; then
          echo 'üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...' &&
          npm install --legacy-peer-deps
        fi &&
        if [ ! -d node_modules/.prisma ]; then
          echo 'üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client...' &&
          npx prisma generate
        fi &&
        if [ -d .next ]; then
          echo 'üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ .next...' &&
          rm -rf .next
        fi &&
        mkdir -p .next &&
        echo '{}' > .next/required-server-files.json &&
        echo 'üöÄ –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 3001...' &&
        npm run dev -- -p 3001 -H 0.0.0.0
      "

volumes:
  staging_postgres_data:
    driver: local
  staging_redis_data:
    driver: local
  staging_uploads:
    driver: local
  staging_logs:
    driver: local
  staging_node_modules:
    driver: local
  staging_next_cache:
    driver: local

networks:
  staging-network:
    driver: bridge

