# üìã –°–∏—Å—Ç–µ–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞

## üéØ –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ (–ö–ü, –°—á–µ—Ç–∞, –ó–∞–∫–∞–∑—ã, –ó–∞–∫–∞–∑—ã —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞) —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã foreign key —Å–≤—è–∑–∏ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
- ‚úÖ `Invoice.quote_id` - –ø—Ä—è–º–∞—è —Å–≤—è–∑—å –ö–ü ‚Üí –°—á–µ—Ç
- ‚úÖ `SupplierOrder.order_id` - —Å–≤—è–∑—å –ó–∞–∫–∞–∑ ‚Üí –ó–∞–∫–∞–∑ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
- ‚úÖ –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `DocumentHistory` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `DocumentTemplate` –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–°–≤—è–∑–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:**
```
Quote (–ö–ü)
‚îú‚îÄ‚îÄ Order (–ó–∞–∫–∞–∑) [quote_id]
‚îÇ   ‚îú‚îÄ‚îÄ Invoice (–°—á–µ—Ç) [order_id]
‚îÇ   ‚îî‚îÄ‚îÄ SupplierOrder (–ó–∞–∫–∞–∑ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞) [order_id]
‚îî‚îÄ‚îÄ Invoice (–°—á–µ—Ç) [quote_id] - –ø—Ä—è–º–∞—è —Å–≤—è–∑—å
```

### 2. API –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞

**`/api/documents/create`** - –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö:
- `POST` - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:
  - –ö–ü ‚Üí –ó–∞–∫–∞–∑
  - –ö–ü ‚Üí –°—á–µ—Ç
  - –ó–∞–∫–∞–∑ ‚Üí –°—á–µ—Ç
  - –ó–∞–∫–∞–∑ ‚Üí –ó–∞–∫–∞–∑ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞

**`/api/documents/related`** - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
- `GET` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —Ç–∏–ø—É –∏ ID
- `POST` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –¥–µ—Ä–µ–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞

### 3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç DocumentTree

–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏:
- üîç –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
- üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- üìä –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ —Å—É–º–º

## üöÄ –í–Ω–µ–¥—Ä–µ–Ω–∏–µ

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npx prisma db push

# –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npx prisma migrate dev --name enhance_document_relationships
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å Prisma —Å—Ö–µ–º—É

–î–æ–±–∞–≤–∏—Ç—å –≤ `prisma/schema.prisma`:

```prisma
model Quote {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  orders       Order[]   @relation("QuoteToOrder")
  invoices     Invoice[] @relation("QuoteToInvoice")
}

model Order {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  quote         Quote?    @relation("QuoteToOrder", fields: [quote_id], references: [id])
  invoices      Invoice[] @relation("OrderToInvoice")
  supplier_orders SupplierOrder[] @relation("OrderToSupplierOrder")
}

model Invoice {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  quote_id     String?   // –ù–æ–≤–æ–µ –ø–æ–ª–µ
  quote          Quote?   @relation("QuoteToInvoice", fields: [quote_id], references: [id])
  order          Order?   @relation("OrderToInvoice", fields: [order_id], references: [id])
}

model SupplierOrder {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  order          Order     @relation("OrderToSupplierOrder", fields: [order_id], references: [id], onDelete: Cascade)
}

model DocumentHistory {
  id          String   @id @default(cuid())
  document_type String
  document_id String
  action      String
  old_value   String?
  new_value   String?
  user_id     String
  notes       String?
  created_at  DateTime @default(now())
  
  @@map("document_history")
}

model DocumentTemplate {
  id          String   @id @default(cuid())
  name        String
  type        String
  template_data String
  is_default  Boolean  @default(false)
  created_by  String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  @@map("document_templates")
}
```

### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**–í ComplectatorDashboard:**
```tsx
import DocumentTree from '../../../components/documents/DocumentTree';

// –í –¥–µ—Ç–∞–ª—è—Ö –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É "–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç"
<DocumentTree 
  clientId={selectedClient}
  onDocumentSelect={(doc) => console.log('Selected:', doc)}
  onCreateDocument={(sourceType, sourceId, targetType) => {
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    createDocumentFromSource(sourceType, sourceId, targetType);
  }}
/>
```

**–í ExecutorDashboard:**
```tsx
// –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å DocumentTree
```

### –®–∞–≥ 4: API —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

```typescript
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
const createDocumentFromSource = async (
  sourceType: string, 
  sourceId: string, 
  targetType: string,
  additionalData?: any
) => {
  try {
    const response = await fetch('/api/documents/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sourceType,
        sourceId,
        targetType,
        userId: user.id,
        additionalData
      })
    });

    if (response.ok) {
      const result = await response.json();
      console.log('Document created:', result.document);
      // –û–±–Ω–æ–≤–∏—Ç—å UI
      fetchClientDocuments(selectedClient);
    }
  } catch (error) {
    console.error('Error creating document:', error);
  }
};
```

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

### 1. **–ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å**
- –ö–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–≤—è–∑–∞–Ω —Å –∏—Å—Ö–æ–¥–Ω—ã–º
- –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–¥–∏—Ç—å –≤–µ—Å—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

### 2. **–ì–∏–±–∫–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**
- –ö–ü ‚Üí –ó–∞–∫–∞–∑ ‚Üí –°—á–µ—Ç ‚Üí –ó–∞–∫–∞–∑ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
- –ö–ü ‚Üí –°—á–µ—Ç (–ø—Ä—è–º–∞—è —Å–≤—è–∑—å)
- –õ—é–±—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

### 3. **–ï–¥–∏–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö**
- –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –æ–¥–Ω–æ–π –ë–î
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏

### 4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –®–∞–±–ª–æ–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
- API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

## üîÑ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏–∑ –ö–ü:
```javascript
await createDocumentFromSource('quote', 'quote_id_123', 'order', {
  notes: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –∑–∞–∫–∞–∑–∞'
});
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞ –∏–∑ –∑–∞–∫–∞–∑–∞:
```javascript
await createDocumentFromSource('order', 'order_id_456', 'invoice', {
  due_date: '2025-02-15',
  notes: '–°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É –∑–∞–∫–∞–∑–∞'
});
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞:
```javascript
const response = await fetch('/api/documents/related', {
  method: 'POST',
  body: JSON.stringify({ clientId: 'client_123' })
});
const { documentTree } = await response.json();
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é** –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å DocumentTree** –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ dashboard'—ã
3. **–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** –≤ UI
4. **–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF/Excel
5. **–î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
6. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–æ–º! üöÄ
