# Система фото с обложками и галереей

## Обзор

Реализована продвинутая система управления фото товаров с поддержкой обложек и галереи. Система позволяет загружать несколько фото к одному товару и отображать их в удобном формате.

## Основные возможности

### 1. Типы фото
- **Обложка** (`d2.png`) - основное фото, отображаемое в каталоге
- **Галерея** (`d2_1.png`, `d2_2.png`, etc.) - дополнительные фото для детального просмотра

### 2. Ограничения
- Максимум 5 дополнительных фото в галерее
- Автоматическая нумерация (1, 2, 3, 4, 5)
- Поддержка пропусков в нумерации

### 3. Логика именования
- Обложка: `{артикул}.png` (например, `d2.png`)
- Галерея: `{артикул}_{номер}.png` (например, `d2_1.png`, `d2_2.png`)

## API Endpoints

### Загрузка фото
```
POST /api/admin/import/photos
```
- Поддерживает загрузку обложек и фото галереи
- Автоматически определяет тип фото по имени файла
- Заменяет существующие фото с тем же номером
- Проверяет лимиты (максимум 5 фото в галерее)

### Получение следующего номера
```
GET /api/admin/photos/next-number?category={id}&mapping_property={prop}&property_value={value}
```
- Возвращает следующий доступный номер для фото галереи
- Учитывает существующие фото товара

### Получение товара с фото
```
GET /api/catalog/products/by-sku/{sku}
```
- Возвращает товар со структурированными фото
- Включает обложку, галерею и метаданные

## Структура данных

### PhotoStructure
```typescript
interface PhotoStructure {
  cover: string | null;    // Обложка
  gallery: string[];       // Массив фото галереи
}
```

### Ответ API товара
```typescript
{
  success: true,
  product: {
    // ... другие поля товара
    photos: {
      structure: PhotoStructure,
      cover: string | null,
      all: string[],
      hasPhotos: boolean,
      count: number
    }
  }
}
```

## UI Компоненты

### PhotoGallery
Компонент для отображения фото с галереей и модальным окном.

**Пропсы:**
- `photos: PhotoStructure` - структура фото
- `productName?: string` - название товара
- `className?: string` - CSS классы

**Возможности:**
- Отображение обложки с индикатором количества фото
- Превью дополнительных фото
- Модальное окно с полноразмерным просмотром
- Навигация клавишами (стрелки, Escape)
- Поддержка touch-событий

## Логика загрузки

### 1. Определение типа фото
```typescript
const photoInfo = parsePhotoFileName('d2_1.png');
// { fileName: 'd2_1.png', isCover: false, number: 1, baseName: 'd2' }
```

### 2. Обработка обложки
- Если загружается обложка (`d2.png`), заменяется существующая обложка
- Если обложки нет, добавляется новая (в начало массива)

### 3. Обработка галереи
- Если загружается фото галереи (`d2_1.png`), заменяется существующее фото с тем же номером
- Если фото с таким номером нет, добавляется новое
- Проверяется лимит (максимум 5 фото)

## Обратная совместимость

Система полностью совместима с существующими данными:
- Старые фото без номеров считаются обложками
- Массив `photos` остается в том же формате
- API возвращает как старый формат, так и новую структуру

## Примеры использования

### Загрузка фото
1. Загрузите обложку: `d2.png`
2. Загрузите дополнительные фото: `d2_1.png`, `d2_2.png`
3. Система автоматически привяжет их к товарам с артикулом "d2"

### Отображение в UI
```tsx
<PhotoGallery 
  photos={product.photos.structure}
  productName={product.name}
  className="w-full"
/>
```

### Получение следующего номера
```javascript
const response = await fetch('/api/admin/photos/next-number?category=cmg50xcgs001cv7mn0tdyk1wo&mapping_property=Артикул поставщика&property_value=d2');
const data = await response.json();
console.log('Следующий номер:', data.nextNumber); // 3
```

## Тестирование

Система протестирована на:
- Парсинг имен файлов
- Структурирование фото
- Получение следующего номера
- Проверка лимитов
- Обратная совместимость

Все тесты пройдены успешно.
